<html>
<head>
</head>

<body>
  <canvas id="attackSpace"></canvas>
</body>

</html>

<script>
  var canvas = document.getElementById('attackSpace');
  var context = canvas.getContext('2d');

  context.canvas.width = window.innerWidth - 30;
  context.canvas.height = window.innerHeight - 30;
  var bottom = context.canvas.height;
  var right = context.canvas.width;
  var centerW = right / 2;
  var centerH = bottom / 2;
  var bottomLimit = bottom - 10;

  var shipWidth = right / 75;
  var shipHeight = shipWidth * 1.5;

  var score = 0;
  var currLevel = 0;
  var gameOver = false;
  var playerShip = null;
  var enemyShips = [];
  var bolts = []; // Tracks all the blaster bolts that have been fired

  function resetBackground() {
    // Set the background to black
    context.fillStyle = 'black';
    context.fillRect(0, 0, context.canvas.width, context.canvas.height);
  }

  function endGame() {
    context.fillStyle = "white";
    context.font = "bold 16px Arial";
    context.fillText("Zibri", (right / 2) - 17, (bottom / 2) + 8);
    gameOver = true;
  }

  function levelGenerator(levelNum) {
    var attrs = {
      speedX: (levelNum * (right / 200)),
      speedY: (levelNum * (bottom / 300)),
      hits: (Math.ceil((levelNum / 10))),
      shotSpeed: (levelNum * (bottom / 200)),
      shotFreq: ((levelNum / 10) + 0.25)
    };

    return attrs;
  }

  var buttonStatus = {
    fire: false,
    left: false,
    right: false,
    up: false,
    down: false,
    rotateLeft: false,
    rotateRight: false
  }
  // Button handlers
  document.onkeydown = function(key) {
    handleKeyPress(key.keyCode, true);
  };

  document.onkeyup = function(key) {
    handleKeyPress(key.keyCode, false);
  };

  function handleKeyPress(keyCode, status) {
    switch (keyCode) {
      case 32:
        // Spacebar
        buttonStatus.fire = status;
        break;
      case 37:
        // Left arrow
        buttonStatus.left = status;
        break;
      case 38:
        // Up arrow
        buttonStatus.up = status;
        break;
      case 39:
        // Right arrow
        buttonStatus.right = status;
        break;
      case 40:
        // Down arrow
        buttonStatus.down = status;
        break;
      case 65:
        // 'A' key
        buttonStatus.left = status;
        break;
      case 87:
        // 'W' key
        buttonStatus.up = status;
        break;
      case 68:
        // 'D' key
        buttonStatus.right = status;
        break;
      case 83:
        // 'S' key
        buttonStatus.down = status;
        break;
      case 81:
        // 'Q' key
        buttonStatus.rotateLeft = status;
        break;
      case 69:
        // 'E' key
        buttonStatus.rotateRight = status;
        break;
      default:
        // Do nothing because we dont recognize the key
        break;
    }
  }

  function BlasterBolt(startX, startY, speed) {
    var that = this;
    this.width = right / 225;
    this.height = bottom / 100;
    this.x = startX;
    this.y = startY + (this.height * Math.sign(speed)); // Need to offset to account for bolt length
    this.speed = speed;

    this.draw = function(color) {
      context.fillStyle = color;
      context.fillRect(that.x, that.y, that.width, that.height);
    };

    this.update = function() {
      that.y += that.speed;
      that.draw('orange');
    };

    this.destroy = function() {
      that.x = 0;
      that.y = 0;
      that.draw('black');
    };
  }

  function PlayerShip(startX, startY, width, height, color) {
    var that = this;
    this.width = width;
    this.height = height;
    this.x = startX;
    // The ship has to stay at least 10 pixels off the bottom
    this.y = (startY + height) > (bottomLimit) ? (bottomLimit - height) : startY;

    this.speedX = width / 2;
    this.speedY = height / 2;
    this.color = color;
    this.fireSpeed = 2; // In Hz
    this.readyToFire = true;

    this.draw = function(color) {
      context.fillStyle = color;
      context.fillRect(that.x, that.y, that.width, that.height);
    };

    this.update = function() {
      // Move X-axis
      if (buttonStatus.left) {
        that.x = (that.x - that.speedX) < 0 ? 0 : (that.x - that.speedX);
      }
      if (buttonStatus.right) {
        that.x = ((that.x + that.width) + that.speedX) > right ? (right - that.width) : (that.x + that.speedX);
      }

      // Move Y-axis
      if (buttonStatus.up) {
        that.y = (that.y - that.speedY) < 0 ? 0 : (that.y - that.speedY);
      }
      if (buttonStatus.down) {
        that.y = ((that.y + that.height) + that.speedY) > bottomLimit ? (bottomLimit - that.height) : (that.y + that.speedY);
      }

      if (buttonStatus.fire) {
        that.fire();
      }

      that.draw(that.color);
    };

    this.fire = function() {
      var offset = (that.width / 4);

      if (that.readyToFire) {
        var shot1 = new BlasterBolt((that.x + offset) , that.y, ((bottom / 100) * -1));
        var shot2 = new BlasterBolt((that.x + (offset * 3)), that.y, ((bottom / 100) * -1));
        bolts.push(shot1);
        bolts.push(shot2);
        that.readyToFire = false;
        window.setTimeout(function() { that.readyToFire = true; }, (1000 / that.fireSpeed));
      }
    };
  }

  function EnemyShip(startX, startY, width, height, color, level) {
    var that = this;
    this.x = startX;
    this.y = startY;
    this.width = width;
    this.height = height;
    this.color = color;
    this.readyToFire = true;

    this.attributes = levelGenerator(level);

    this.draw = function(color) {
      context.fillStyle = color;
      context.beginPath();
      context.moveTo(that.x + (that.width / 2), that.y + that.height);
      context.lineTo(that.x, that.y);
      context.lineTo(that.x + that.width, that.y);
      context.fill();
    };

    this.update = function() {
      var newXPos = that.attributes.speedX + that.x;
      if (newXPos > right) {
        newXPos = (right - (newXPos - right));
        // Reverse direction
        that.attributes.speedX = that.attributes.speedX * - 1;
      }

      var newYPos = that.attributes.speedY + that.y;
      if (newYPos > bottomLimit) {
        newYPos = (bottomLimit - (newYPos - bottomLimit))
      }

      if (newYPos > bottomLimit) {
        endGame();
      }

      that.x = newXPos;
      that.y = newYPos;
      that.draw(that.color);

      that.fire();
    };

    this.fire = function() {
      if (that.readyToFire) {
        var offset = that.width / 2;
        var shot = new BlasterBolt((that.x + offset), (that.y + that.height), that.attributes.shotSpeed);
        bolts.push(shot);
        that.readyToFire = false;
        window.setTimeout(function() { that.readyToFire = true; }, (1000 / that.attributes.shotFreq));
      }
    };
  };

  var playerShip = new PlayerShip(centerW, bottomLimit - shipHeight, shipWidth, shipHeight, 'green');
  for (var i = 0; i < 10; i++) {
    enemyShips.push(new EnemyShip(30, 30, 40, 60, 'yellow', 0));
  }

  var gameLoop = setInterval(function() {
    resetBackground();
    playerShip.update();
    for (var b = 0; b < bolts.length; b++) {
      var bolt = bolts[b];
      bolt.update();
    }

    for (var e = 0; e < enemyShips.length; e++) {
      var enemy = enemyShips[e];
      enemy.update();
    }
  }, 30); // Sets it to redraw about ~30Hz
</script>
